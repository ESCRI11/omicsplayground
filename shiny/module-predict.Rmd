Biomarker
================================================================================

Inputs {.sidebar data-width=250}
--------------------------------------------------------------------------------

<br> Feature selection and prediction module.

<br><br>

```{r}
radioButtons('pdx_vartype',NULL,c("contrast","phenotype"),inline=TRUE)
selectInput("pdx_contrast",NULL, choices=NULL)
selectInput("pdx_level","Level:", choices=c("gene","geneset"))
selectInput("pdx_filter","Filter:", choices=NULL)
selectizeInput("pdx_select","Custom select:", choices=NULL, multiple=TRUE)
##checkboxInput('pdx_normalize','normalize',TRUE)
br();br();br();
if(PRO.VERSION) checkboxInput('pdx_showloops','detect loops',FALSE)
if(PRO.VERSION) checkboxInput('pdx_posonly','pos.only',FALSE)
##if(DEV.VERSION) checkboxInput('pdx_multiomics','multi-omics',FALSE)

input_pdx_select <- reactive({
    input$pdx_select
}) %>% debounce(3000)

observe({
    ngs <- inputData()
    if(is.null(ngs)) return(NULL)
    ct <- colnames(ngs$model.parameters$contr.matrix)
    if(input$pdx_vartype=="phenotype") {
        ct <- colnames(ngs$Y)
        ct <- grep("group|sample|patient|donor",ct,value=TRUE,invert=TRUE)
    }
    cat("<predict::observe1> updating pdx_contrast...\n")
    updateSelectInput(session, "pdx_contrast", choices=ct )
    
})

observe({
    ngs <- inputData()
    if(is.null(ngs)) return(NULL)
    cat("<module-predict:observe2>\n")    
    if(input$pdx_level=="geneset") {
        ft <- names(COLLECTIONS)
        nn <- sapply(COLLECTIONS, function(x) sum(x %in% rownames(ngs$gsetX)))
        ft <- ft[nn >= 10]
    } else {
        ## gene level
        ft <- pgx.getExtendedFamilies(ngs,10)
    }
    cat("<predict::observe2> updating pdx_filter: len.ft=",length(ft),"\n")
    ft <- sort(ft)
    updateSelectInput(session, "pdx_filter", choices=ft )    
})

observe({
    ngs <- inputData()
    if(is.null(ngs)) return(NULL)
    ft <- input$pdx_filter
    ct <- input$pdx_contrast
    if(is.null(ft)) return(NULL)
    if(is.null(ct)) return(NULL)    
    
    cat("<predict:observe3>\n")

    if(ft=="") return(NULL)
    if(ct=="") return(NULL)    
    
    if(input$pdx_level=="geneset") {
        if(!ft %in% names(COLLECTIONS)) return(NULL)
        pp <- COLLECTIONS[[ft]]              
        pp <- intersect(pp, rownames(ngs$gsetX))
        if(input$pdx_vartype=="contrast") {
            if(!ct %in% names(ngs$gset.meta$meta)) return(NULL)    
            ii <- which( ngs$gset.meta$meta[[ct]]$meta.p < 0.05 &
                         abs(ngs$gset.meta$meta[[ct]]$meta.fx) > 0.5 )
            sig <- rownames(ngs$gset.meta$meta[[ct]])[ii]
            pp <- intersect(sig,pp)
        }
    } else {
        xfam <- c(names(ngs$families),names(GSETS))
        if(!ft %in% xfam) return(NULL)
        sel <- ngs$genes$gene_name
        sel <- NULL
        if(ft %in% names(ngs$families)) sel <- ngs$families[[ft]]
        if(ft %in% names(GSETS)) sel <- GSETS[[ft]]
        xgene <- ngs$genes[rownames(ngs$X),"gene_name"]
        sel <- intersect(sel, xgene)
        pp = filterProbes(ngs$genes, sel)
        length(pp)
        if(input$pdx_vartype=="contrast") {
            if(!ct %in% names(ngs$gx.meta$meta)) return(NULL)    
            ii <- which( ngs$gx.meta$meta[[ct]]$meta.p < 0.05 &
                         abs(ngs$gx.meta$meta[[ct]]$meta.fx) > 0.5 )
            sig <- rownames(ngs$gx.meta$meta[[ct]])[ii]
            pp <- intersect(sig,pp)
        }
    }
    pp <- c("",pp)
    updateSelectInput(session, "pdx_select", choices=pp, sel="")    

})

```


Col {.tabset data-width=650}
----------------------------------------------------------------------------------------

### Importance
    
```{r message=FALSE, warning=FALSE, fig.width=4}

fillRow(flex = c(1.2,0.1,1), 
        fillCol(flex = c(0.7,1), 
                plotOutput('pdx_importanceplot'),
                plotOutput('pdx_heatmap')
                ),
        br(), ## spacer
        fillCol(flex = c(1,0.8), 
                ##plotOutput('pdx_decisiontree'),
                uiOutput('pdx_decisiontree'),
                plotOutput('pdx_boxplots')
                )
        )

calcVariableImportance <- reactive({

    ngs <- inputData()
    if(is.null(ngs)) return(NULL)
    
    ct=2
    ct=1
    colnames(ngs$Y)
    ct <- input$pdx_contrast
    if(is.null(ct)) return(NULL)

    NFEATURES=50
    
    cat("calcVariableImportance:: 1\n")
    
    if(input$pdx_vartype=="contrast") {
        cts <- colnames(ngs$model.parameters$exp.matrix)
        if(!(ct %in% cts)) return(NULL)
        y0 <- ngs$model.parameters$exp.matrix[,ct]
        y0 <- y0[which(y0!=0)]
        y <- 1*(y0>0)
        if(1 && grepl("_vs_|_VS_",ct)) {
            cls <- strsplit(ct, split="_vs_|_VS_")[[1]]
            y[which(y==1)] <- cls[1]
            y[which(y==0)] <- cls[2]
        }

    }
    if(input$pdx_vartype=="phenotype") {
        if(!(ct %in% colnames(ngs$Y))) return(NULL)
        y0 <- ngs$Y[,ct]
        names(y0) <- rownames(ngs$Y)
        y <- y0[!is.na(y0)]
    }
    table(y)
    if(length(y)<40) y <- head(rep(y,10),100)  ## augment to 100 samples
    table(y)

    cat("calcVariableImportance:: 2\n")
    
    ##-------------------------------------------
    ## select features
    ##-------------------------------------------
    if(input$pdx_vartype=="contrast") {
        ## contrast prediction
        if(input$pdx_level=="geneset") {
            ii <- which( ngs$gset.meta$meta[[ct]]$meta.p < 0.05 &
                         abs(ngs$gset.meta$meta[[ct]]$meta.fx) > 0.5 )
            sel <- rownames(ngs$gset.meta$meta[[ct]])[ii]
            X <- ngs$gsetX[sel,names(y)]
        } else {
            ii <- which( ngs$gx.meta$meta[[ct]]$meta.p < 0.05 &
                         abs(ngs$gx.meta$meta[[ct]]$meta.fx) > 0.5 )
            sel <- rownames(ngs$gx.meta$meta[[ct]])[ii]
            X <- ngs$X[sel,names(y)]
        }
    } else {
        ## group prediction
        if(input$pdx_level=="geneset") {
            X <- ngs$gsetX[,names(y)]
        } else {
            X <- ngs$X[,names(y)]
        }
    }
    dim(X)
    length(y)
    
    ## ----------- filter with selected features
    cat("calcVariableImportance:: 3: filtering\n")

    ft="<all>"
    ft <- input$pdx_filter
    if(is.null(ft)) return(NULL)

    pp <- rownames(X)
    if(input$pdx_level=="geneset") {
        if(!(ft %in% names(COLLECTIONS))) return(NULL)
        pp <- COLLECTIONS[[ft]]
    } else {
        xfam <- c(names(ngs$families),names(GSETS))
        if(!ft %in% xfam) return(NULL)
        gg <- GSETS[[8]]
        gg <- NULL
        if(ft %in% names(ngs$families)) gg <- ngs$families[[ft]]
        if(ft %in% names(GSETS)) gg <- GSETS[[ft]]
        pp = filterProbes(ngs$genes, gg)
    }
    pp <- intersect(pp,rownames(X))
    X <- X[pp,,drop=FALSE]

    ## ------------- filter with user selection
    ##sel <- input$pdx_select
    sel <- input_pdx_select()
    if(!is.null(sel) && length(sel)>0) {
        if(sel[1]!="") {
            pp <- intersect(rownames(X),sel)
            X <- X[pp,,drop=FALSE]
        }
    }

    cat("calcVariableImportance:: 4: restrict top: dim.X=",dim(X),"\n")
        
    ## ----------- restrict to top 100
    dim(X)
    X <- head(X[order(-apply(X,1,sd)),,drop=FALSE], 10*NFEATURES)  ## top 100
    sdx <- mean(apply(X,1,sd))
    X <- X + 0.25*sdx*matrix(rnorm(length(X)),nrow(X),ncol(X))  ## add some noise
    dim(X)

    cat("calcVariableImportance:: 4: compute importance...\n")
    cat("calcVariableImportance:: 4: table.y=",table(y),"\n")
    
    ##-------------------------------------------
    ## compute importance values
    ##-------------------------------------------
    if(grepl("survival",ct)) {
        time <- abs(y)
        status <- (y > 0) ## dead is positive time
        methods=c("glmnet","randomforest","boruta","xgboost","pls")
        methods=c("glmnet","randomforest","xgboost","pls")
        P <- pgx.survivalVariableImportance(
            X, time=time, status=status, methods=methods)    
    } else {
        methods=c("glmnet","randomforest","boruta","xgboost","pls")
        methods=c("glmnet","randomforest","xgboost","pls")
        X1=X;y1=y
        names(y1) = colnames(X1) = paste0("x",1:ncol(X))
        P <- pgx.multiclassVariableImportance(X1, y1, methods=methods)    
        ##P <- pgx.variableImportance(X1, y1, methods=methods)
    }
    P <- abs(P)
    head(P)
    
    P[is.na(P)] <- 0
    P[is.nan(P)] <- 0
    P <- t( t(P) / (1e-3+apply(P,2,max,na.rm=TRUE)))
    ##P <- pmax(P,0.1)
    P <- P[order(-rowSums(P,na.rm=TRUE)),,drop=FALSE]
    head(P)

    R <- P
    if(nrow(R)>1) {
        R <- (apply(P,2,rank)/nrow(P))**4
        R <- R[order(-rowSums(R)),,drop=FALSE]
        head(R)
    }

    cat("calcVariableImportance:: 5: drawing tree\n")
    
    ##------------------------------
    ## create partition tree
    ##------------------------------
    require(rpart)
    sel <- head(rownames(R),100)
    sel <- head(rownames(R),NFEATURES)  ## top50 features
    sel <- intersect(sel,rownames(X))
    tx <- t(X[sel,,drop=FALSE])

    ## formula wants clean names
    colnames(tx) <- gsub("[: +-.,]","_",colnames(tx))
    colnames(tx) <- gsub("[')(]","",colnames(tx))
    orig.names <- sel
    names(orig.names) <- colnames(tx)
    jj <- names(y)
    ##ny <- length(unique(y))
    ##if(length(jj) < ny*20) jj <- c(jj,jj,jj)
    if(grepl("survival",ct)) {
        require(survival)
        time <- abs(y)
        status <- (y>0) ## dead if positive time
        df <- data.frame( time=time+0.001, status=status, tx)
        ##df <- df[jj,]
        rf <- rpart( Surv(time,status) ~ ., data=df)
    } else {
        df <- data.frame( y=y, tx)
        ##df <- df[jj,]
        rf <- rpart( y ~ ., data=df)
    }
    table(rf$where)
    rf$cptable
    rf$orig.names <- orig.names
    
    rf.nsplit <- rf$cptable[,"nsplit"]
    max(rf.nsplit)
    length(unique(y)) 
    if(grepl("survival",ct)) {
        MAXSPLIT = 4  ## maximum five groups....
    } else {
        MAXSPLIT = 1.5*length(unique(y))  ## maximum N+1 groups
    }
    if( max(rf.nsplit) > MAXSPLIT) {
        cp.idx <- max(which(rf.nsplit <= MAXSPLIT))
        cp0 <- rf$cptable[cp.idx,"CP"]
        ##rf <- prune(rf, cp=0.05)
        rf <- prune(rf, cp=cp0)
    }
    table(rf$where)

    

    
    cat("calcVariableImportance:: done\n")
    ##y <- y[rownames(ngs$samples)]
    ##tx <- tx[names(y),]
    y <- y[rownames(tx)]
    res <- list(P=P, R=R, y=y, X=t(tx), rf=rf)

    return(res)
})


output$pdx_importanceplot <- renderPlot({
    
    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)
    P <- res$P    
    P <- res$R
    P <- P[order(-rowSums(P,na.rm=TRUE)),,drop=FALSE]
    P <- pmax(P,0.05)

    if(input$pdx_level=="geneset") {
        par(mfrow=c(1,2), oma=c(1,1,1,1)*0.5, mgp=c(2.2,0.8,0))
        par(mar=c(4,8,2,4))
        frame()
        P.top <- head(P,20)
        rownames(P.top) <- tolower(rownames(P.top))
        rownames(P.top) <- substring(rownames(P.top),1,60)
        barplot( t(P.top), las=1, horiz=TRUE,
                cex.names=0.95, xlab="cumulative importance" )
        klr <- grey.colors(ncol(P))
        legend("topright",
               legend = colnames(P), fill=klr,
               cex=0.8, y.intersp=0.85, inset=c(-0.25,0), xpd=NA )

    } else {
        par(mfrow=c(1,1), oma=c(1,1,1,1)*0.5)
        par(mar=c(7,4,2,4))
        P.top <- head(P,50)
        barplot( t(P.top), las=3, horiz=FALSE,
                cex.names=0.9, ylab="cumulative importance" )
        klr <- grey.colors(ncol(P))
        legend("topright",
               legend=rev(colnames(P)), fill=rev(klr),
               cex=0.9, y.intersp=0.85 )
    }
    title("Variable importance", cex.main=1.2, line=1.2, adj=0.3)
    
}, res=70)

output$pdx_decisiontree <- renderUI({

    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)
    is.surv <- grepl("Surv",res$rf$call)[2]
    is.surv
    if(is.surv) {
        plotOutput("pdx_decisiontreeSurv")
    } else {
        ##visNetworkOutput("pdx_decisiontreeClass")
        plotOutput("pdx_decisiontreeClass")
    } 
})
    
output$pdx_decisiontreeSurv <- renderPlot({    
    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)
    
    ##install.packages("rpart.plot")
    require(rpart)
    require(rpart.plot)
    par(mfrow=c(1,1), mar=c(1,0,2,0))
    
    ##ct <- input$pdx_contrast
    ##is.surv <- ( input$pdx_vartype=="phenotype" &
    ##             grepl("survival",ct))
    ##install.packages("partykit")
    require(survival)
    require("partykit")
    (rf <- as.party(res$rf))
    ##(rf <- as.party(prune(res$rf, cp=0.05)))
    plot(rf)
    title("Survival tree",cex=1.2,line=0.9,adj=0.35)
    table(res$rf$where)
})

##output$pdx_decisiontreeClass <- renderVisNetwork({
output$pdx_decisiontreeClass <- renderPlot({    
    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)
    
    ##install.packages("rpart.plot")
    require(rpart)
    ##par(mfrow=c(1,1), mar=c(1,0,2,0))
    require(visNetwork)
    require(rpart.plot)
    if(1) {
        rpart.plot(res$rf)
        title("Classification tree",cex=1.2,line=3,adj=0.35)
    } else {
        visTree(res$rf, main="Classification tree",width="100%",legend=FALSE) %>%
            visInteraction(tooltipStyle='position:fixed;visibility:hidden;padding:5px;white-space:nowrap;font-family:helvetica;font-size:10px;background-color:lightgrey;')
    }
})    

output$pdx_boxplots <- renderPlot({
    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)

    cat("pdx_boxplots:: called\n")    
    vars <- setdiff(res$rf$frame$var,"<leaf>")
    vars <- res$rf$orig.names[vars]
    if(length(vars)==0) return(NULL)
    
    cat("pdx_boxplots:: 1: vars=",vars,"\n")
    ##vars0 <- setdiff(vars,rownames(res$X))
    ##cat("pdx_boxplots:: vars0=",vars0,"\n")
    vars <- intersect(vars,rownames(res$X))
    cat("pdx_boxplots:: 2: vars=",vars,"\n")
    
    ## add some other variables
    if(1 && length(vars)<8) {
        jj <- order(-rowSums(res$R,na.rm=TRUE))
        other.vars <- rownames(res$R)[jj]
        vars <- head(unique(c(vars,other.vars)),8)
    }
    cat("pdx_boxplots:: 3: vars=",vars,"\n")
    
    y <- res$y
    is.surv <- grepl("Surv",res$rf$call)[2]
    is.surv
    if(is.surv) 
    {
        y <- paste0("N",res$rf$where)
        ##y <- as.integer(factor(y, levels=sort(unique(y))))
        names(y) <- colnames(res$X)
        table(y)
    }

    ny <- length(unique(y))    
    par(mfrow=c(2,4), mar=c(3.5,3,2,0.5),
        mgp=c(2,0.8,0), oma=c(0.5,1,1,1)*0)
    if(length(vars)>8) par(mfrow=c(3,4), mar=c(2.8,3,2,0.3),)
    i=1
    for(i in 1:min(12,length(vars))) {
        ##g <- rownames(res$R)[i]
        g <- vars[i]
        gx <- res$X[g,]
        boxplot( gx ~ y, col="grey85", ylim = range(gx),
                ylab="expression", cex.axis=0.001)
        axis(2, cex.axis=0.9)
        ##axis(1, at=1:ny, labels=levels(factor(y)), cex.axis=0.6)
        cex1 <- ifelse( ny >= 8, 0.7, 0.85)
        title(g, cex.main=ifelse(nchar(g)>20,0.85,1))
        nchar(y)
        too.big = (max(nchar(y)>6) && ny==2) || (max(nchar(y)>4) && ny>2)
        if(too.big) {
            dy <- min(gx) - 0.16*diff(range(gx))        
            text(1:ny, dy, levels(factor(y)), xpd=NA,
                 cex=cex1, srt=30, adj=1)
        } else {
            mtext(levels(factor(y)), side=1, line=0.7,
                  cex=cex1*0.9, las=1, at=1:ny)
        }

    }

}, res=100)


output$pdx_heatmap <- renderPlot({

    ngs <- inputData()
    if(is.null(ngs)) return(NULL)
    
    res <- calcVariableImportance()
    if(is.null(res)) return(NULL)

    cat("<predict:pdx_heatmap> called\n")
    
    gg <- NULL
    if(input$pdx_level=="geneset") {
        gg <- rownames(res$X)
        gg <- intersect(gg, rownames(ngs$gsetX))
        X <- ngs$gsetX[gg,]
        rownames(X) <- tolower(rownames(X))
    } else {
        gg <- rownames(res$X)
        gg <- intersect(gg, rownames(ngs$X))
        X <- ngs$X[gg,]
    }

    cat("<predict:pdx_heatmap> dim(X)=",dim(X),"\n")
    
    rownames(X) <- substring(rownames(X),1,40)    
    annot <- ngs$Y[colnames(X),]
    gx.splitmap( X, split=NULL, lab.len=50,
                col.annot=annot, annot.ht=2.5, 
                cexRow=0.85, mar=c(2,8))

})    

```
